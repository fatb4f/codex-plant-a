#!/usr/bin/env bash
set -euo pipefail

cmd="$1"
shift
repo_root="$1"
shift
codex_home="${1:-${CODEX_HOME:-${XDG_CONFIG_HOME:-$HOME/.config}/codex}}"
shift
ctrlex_root="${CTRLEX_ROOT:-$codex_home/skills/vendor/ctrlex}"
if [ ! -d "$ctrlex_root" ]; then
  printf 'ERROR: CTRLEX_ROOT not found at %s. Set CTRLEX_ROOT to your ctrlex checkout under $CODEX_HOME/skills/vendor/ctrlex.\n' "$ctrlex_root" >&2
  exit 1
fi
state_root="$codex_home/ctrlex"

case "$cmd" in
  preflight)
    python3 "$ctrlex_root/tools/root_preflight.py" --repo-root "$repo_root" --codex-home "$codex_home"
    ;;
  enter_work)
    contract="$1"
    python3 "$ctrlex_root/tools/g0_enter_work.py" --repo-root "$repo_root" --codex-home "$codex_home" "$contract"
    ;;
  run_packet)
    contract="$1"
    python3 "$ctrlex_root/tools/run_packet.py" --repo-root "$repo_root" --codex-home "$codex_home" "$contract"
    ;;
  collect_evidence)
    contract="$1"
    python3 "$ctrlex_root/tools/evidence/collect_packet_evidence.py" --repo-root "$repo_root" --codex-home "$codex_home" "$contract"
    ;;
  doctor)
    printf 'repo_root=%s\n' "$(cd "$repo_root" && pwd -P)"
    printf 'CODEX_HOME=%s\n' "$codex_home"
    printf 'CTRLEX_ROOT=%s\n' "$ctrlex_root"
    printf 'state_root=%s (exists=%s)\n' "$state_root" "$(if [ -d "$state_root" ]; then printf yes; else printf no; fi)"
    ;;
  *)
    printf 'Unknown command: %s\n' "$cmd" >&2
    exit 2
    ;;
esac
